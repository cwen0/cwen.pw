title: TC - Linux æµé‡æ§åˆ¶å·¥å…·
author: cwen
date:  2018-05-23
update:  2018-05-23
tags:
    - Linux
    - network
    - ç½‘ç»œ
    - å·¥å…·

---
æœ€è¿‘ä¸€ä¸ªæ–°ä»»åŠ¡ï¼Œéœ€è¦æ¨¡æ‹Ÿé™åˆ¶ä¸»æœºå¸¦å®½çš„åœºæ™¯ï¼Œä¹‹å‰åªæ˜¯çŸ¥é“ä½¿ç”¨ `tc` æ˜¯å¯ä»¥åšåˆ°æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿã€ç½‘ç»œä¸¢åŒ…ç­‰æƒ…å†µï¼Œæ‰€æœ‰å°±æƒ³åº”è¯¥ `tc` ä¹Ÿå¯ä»¥æå®šé™åˆ¶å¸¦å®½çš„æƒ…å†µï¼Œå°±åœ¨ç½‘ä¸Šæœäº†ä¸€æ³¢ï¼Œæœä¸å…¶ç„¶ `tc` è¿˜æ˜¯å¼ºå¤§ï¼Œå¯æ˜¯å¯¹äºç”¨æ¥é™åˆ¶å¸¦å®½ï¼Œæ“ä½œèµ·æ¥è¿˜æ˜¯å¾ˆè›‹ç–¼ï¼Œè¸©äº†ä¸å°‘å‘.. <!--more-->

## ç®€å•è¯´ä¸€ä¸‹åŸç†

æœ¬æ¥æ‰“ç®—ç›´æ¥åˆ—ä¸€æ³¢ç”¨æ³•ï¼Œä½†æ˜¯æ€»è§‰å¾—ï¼Œä¸è®°å½•ä¸€ä¸‹åŸç†ï¼Œæ“ä½œèµ·æ¥ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼ã€‚
TC é€šè¿‡å»ºç«‹å¤„ç†æ•°æ®åŒ…é˜Ÿåˆ—ï¼Œå¹¶å®šä¹‰é˜Ÿåˆ—ä¸­æ•°æ®åŒ…è¢«å‘é€çš„æ–¹å¼ï¼Œä»è€Œå®ç°è¿›è¡Œæµé‡æ§åˆ¶ã€‚TC æ¨¡æ‹Ÿå®ç°æµé‡æ§åˆ¶åŠŸèƒ½ä½¿ç”¨çš„é˜Ÿåˆ—åˆ†ä¸ºä¸¤ç±»ï¼š

* æ— ç±»é˜Ÿåˆ—ï¼ˆclsslessï¼‰: ä½¿ç”¨ classless é˜Ÿåˆ—ï¼ŒTC å¯¹è¿›å…¥ç½‘å¡çš„æµé‡ä¸åŠ ä»»ä½•åŒºåˆ†ï¼Œç»Ÿä¸€å¯¹å¾…, å¸¸ç”¨çš„æ— ç±»é˜Ÿåˆ—æœ‰ **pfifo _fast (å…ˆè¿›ç°å‡º) ã€TBF ( ä»¤ç‰Œæ¡¶è¿‡æ»¤å™¨) ã€SFQ(éšæœºå…¬å¹³é˜Ÿåˆ—) ã€ID (å‰ å‘éšæœºä¸¢åŒ…)** ç­‰ç­‰ã€‚è¿™ç±»é˜Ÿåˆ—è§„å®šä½¿ç”¨çš„æµé‡æ•´å½¢æ‰‹æ®µä¸»è¦ æ˜¯æ’åºã€é™é€Ÿå’Œä¸¢åŒ…ã€‚
    * fifo, ä½¿ç”¨æœ€ç®€å•çš„ qdiscï¼ˆæ’é˜Ÿè§„åˆ™ï¼‰ï¼Œçº¯ç²¹çš„å…ˆè¿›å…ˆå‡ºã€‚åªæœ‰ä¸€ä¸ªå‚æ•°ï¼šlimit ï¼Œç”¨æ¥è®¾ç½®é˜Ÿåˆ—çš„é•¿åº¦ï¼Œpfifo æ˜¯ä»¥æ•°æ®åŒ…çš„ä¸ªæ•°ä¸ºå•ä½ï¼›bfifo æ˜¯ä»¥å­—èŠ‚æ•°ä¸ºå•ä½ã€‚
    * pfifo_fastï¼Œåœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œå¦‚æœæ‰“å¼€äº†é«˜çº§è·¯ç”±å™¨ï¼ˆAdvanced Routerï¼‰ç¼–è¯‘é€‰é¡¹ï¼Œpfifo_fast å°±æ˜¯ç³»ç»Ÿçš„æ ‡å‡† qdisc(æ’é˜Ÿè§„åˆ™)ã€‚å®ƒçš„é˜Ÿåˆ—åŒ…æ‹¬ä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰ã€‚åœ¨æ¯ä¸ªæ³¢æ®µé‡Œé¢ï¼Œä½¿ç”¨å…ˆè¿›å…ˆå‡ºè§„åˆ™ã€‚è€Œä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰çš„ä¼˜å…ˆçº§ä¹Ÿä¸ç›¸åŒï¼Œband 0 çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œband 2 çš„æœ€ä½ã€‚å¦‚æœ band 0 é‡Œé¢æœ‰æ•°æ®åŒ…ï¼Œç³»ç»Ÿå°±ä¸ä¼šå¤„ç† band 1 é‡Œé¢çš„æ•°æ®åŒ…ï¼Œband 1 å’Œ band 2 ä¹‹é—´ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ•°æ®åŒ…æ˜¯æŒ‰ç…§æœåŠ¡ç±»å‹ï¼ˆType Of Serviceï¼ŒTOS ï¼‰è¢«åˆ†é…åˆ°ä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰é‡Œé¢çš„ã€‚
    * redï¼Œred æ˜¯ Random Early Detectionï¼ˆéšæœºæ—©æœŸæ¢æµ‹ï¼‰çš„ç®€å†™ã€‚å¦‚æœä½¿ç”¨è¿™ç§ qdsicï¼Œå½“å¸¦å®½çš„å ç”¨æ¥è¿‘ä¸è§„å®šçš„å¸¦å®½æ—¶ï¼Œç³»ç»Ÿä¼šéšæœºçš„ä¸¢å¼ƒä¸€äº›æ•°æ®åŒ…ã€‚ä»–éå¸¸é€‚åˆé«˜å¸¦å®½çš„åº”ç”¨ã€‚
    * sfqï¼Œsfq æ˜¯ Stochastic Fairness Queueing çš„ç®€å†™ã€‚å®ƒä¼šæŒ‰ç…§ä¼šè¯ï¼ˆsession -- å¯¹åº”ä¸æ¯ä¸ª TCP è¿æ¥æˆ–è€… UDP æµï¼‰ä¸ºæµé‡è¿›è¡Œæ’åºï¼Œç„¶åå¾ªç¯å‘é€æ¯ä¸ªä¼šè¯çš„æ•°æ®åŒ…ã€‚
    * tbfï¼Œtbf æ˜¯ Token Bucket Filter çš„ç®€å†™ï¼Œé€‚ç”¨äºæŠŠæµé€Ÿé™ä½åˆ°æŸä¸ªå€¼ã€‚
* åˆ†ç±»é˜Ÿåˆ—ï¼ˆclassfulï¼‰ï¼šå½“ä½¿ç”¨ classful é˜Ÿåˆ—æ—¶ï¼ŒTC å¯¹è¿›è¡Œçš„ç½‘ç»œè®¾å¤‡çš„æ•°æ®åŒ…æ ¹æ®ä¸åŒçš„éœ€æ±‚è¿›è¡Œåˆ†ç±»å¤„ç†ã€‚TC ä½¿ç”¨è¿‡æ»¤å™¨è¿›è¡Œåˆ†ç±»ï¼ŒTC æ ¹æ®è¿‡æ»¤å™¨å®šä¹‰çš„è§„åˆ™åŒ¹é…ç›¸åº”çš„æ•°æ®åŒ…ï¼Œå‘é€åˆ°å¯¹åº”çš„åˆ†ç±»é˜Ÿåˆ—ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å¯¹å­ç±»åœ¨æ¬¡ä½¿ç”¨è¿‡æ»¤å™¨è¿›è¡Œåˆ†ç±»ã€‚ç†è®ºä¸Šè¿™å¯ä»¥æ˜¯ä¸€ä¸ªæ— é™æ·±åº¦çš„æ ‘ã€‚
    * CBQï¼ŒCBQ æ˜¯ Class Based Queueingï¼ˆåŸºäºç±»åˆ«æ’é˜Ÿï¼‰çš„ç¼©å†™ã€‚å®ƒå®ç°äº†ä¸€ä¸ªä¸°å¯Œçš„è¿æ¥å…±äº«ç±»åˆ«ç»“æ„ï¼Œæ—¢æœ‰é™åˆ¶ï¼ˆshapingï¼‰å¸¦å®½çš„èƒ½åŠ›ï¼Œä¹Ÿå…·æœ‰å¸¦å®½ä¼˜å…ˆçº§åˆ«ç®¡ç†çš„èƒ½åŠ›ã€‚å¸¦å®½é™åˆ¶æ˜¯é€šè¿‡è®¡ç®—è¿æ¥çš„ç©ºé—²æ—¶é—´å®Œæˆçš„ã€‚ç©ºé—²æ—¶é—´çš„è®¡ç®—æ ‡å‡†æ˜¯æ•°æ®åŒ…ç¦»é˜Ÿäº‹ä»¶çš„é¢‘ç‡å’Œä¸‹å±‚è¿æ¥ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰çš„å¸¦å®½ã€‚
    * HTBï¼ŒHTB æ˜¯ Hierarchy Token Bucket çš„ç¼©å†™ã€‚é€šè¿‡åœ¨å®è·µåŸºç¡€ä¸Šçš„æ”¹è¿›ï¼Œå®ƒå®ç°ä¸€ä¸ªä¸°å¯Œçš„è¿æ¥å…±äº«ç±»åˆ«ä½“ç³»ã€‚ä½¿ç”¨ HTB å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿è¯æ¯ä¸ªç±»åˆ«çš„å¸¦å®½ï¼Œè™½ç„¶å®ƒä¹Ÿå…è®¸ç‰¹å®šçš„ç±»å¯ä»¥çªç ´å¸¦å®½ä¸Šé™ï¼Œå ç”¨åˆ«çš„ç±»çš„å¸¦å®½ã€‚HTB å¯ä»¥é€šè¿‡ TBFï¼ˆToken Bucket Filterï¼‰å®ç°å¸¦å®½é™åˆ¶ï¼Œä¹Ÿèƒ½å¤Ÿåˆ’åˆ†ç±»åˆ«çš„ä¼˜å…ˆçº§ã€‚
    * PRIOï¼ŒPRIO qdisc ä¸èƒ½é™åˆ¶å¸¦å®½ï¼Œå› ä¸ºå±äºä¸åŒç±»åˆ«çš„æ•°æ®åŒ…æ˜¯é¡ºåºç¦»é˜Ÿçš„ã€‚ä½¿ç”¨ PRIO qdisc å¯ä»¥å¾ˆå®¹æ˜“å¯¹æµé‡è¿›è¡Œä¼˜å…ˆçº§ç®¡ç†ï¼Œåªæœ‰å±äºé«˜ä¼˜å…ˆçº§ç±»åˆ«çš„æ•°æ®åŒ…å…¨éƒ¨å‘é€å®Œæ¯•ï¼Œå‚ä¼šå‘é€å±äºä½ä¼˜å…ˆçº§ç±»åˆ«çš„æ•°æ®åŒ…ã€‚ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œéœ€è¦ä½¿ç”¨ iptables æˆ–è€… ipchains å¤„ç†æ•°æ®åŒ…çš„æœåŠ¡ç±»å‹ï¼ˆType Of Serviceï¼ŒTOSï¼‰ã€‚

classful é˜Ÿåˆ—è§„å®šï¼ˆqdiscï¼‰, ç±»ï¼ˆclassï¼‰å’Œè¿‡æ»¤å™¨ï¼ˆfilterï¼‰è¿™ 3 ä¸ªç»„ä»¶ç»„æˆï¼Œç»˜å›¾ä¸­ä¸€èˆ¬ç”¨åœ†å½¢è¡¨ç¤ºé˜Ÿåˆ—è§„å®šï¼Œç”¨çŸ©å½¢è¡¨ç¤ºç±»ï¼Œå›¾ copy è‡ª [Linux ä¸‹ TC ä»¥åŠ netem é˜Ÿåˆ—çš„ä½¿ç”¨](http://blog.51cto.com/professor/1570778)

![](http://7xnp02.com1.z0.glb.clouddn.com/wKiom1RU0lKAEIb9AAFPHLlaSng303.jpg)


çœ‹ä¸€å¼ å›¾è¯´æ˜ä¸€ä¸‹åŸºæœ¬åŸç†ï¼ˆç›´æ¥ copy è‡ª [æµé‡æ§åˆ¶å·¥å…· TC è¯¦ç»†è¯´æ˜](http://www.ituring.com.cn/article/274014)ï¼š
![](http://7xnp02.com1.z0.glb.clouddn.com/image_1b6at6vf47qubm51vq69qvaod1g.png)

* æ¥æ”¶åŒ…ä»è¾“å…¥æ¥å£ï¼ˆInput Interfaceï¼‰è¿›æ¥åï¼Œç»è¿‡æµé‡é™åˆ¶ï¼ˆIngress Policingï¼‰ä¸¢å¼ƒä¸ç¬¦åˆè§„å®šçš„æ•°æ®åŒ…ï¼Œç”±è¾“å…¥å¤šè·¯åˆ†é…å™¨ï¼ˆInput De-Multiplexingï¼‰è¿›è¡Œåˆ¤æ–­é€‰æ‹©......
* å¦‚æœæ¥æ”¶åŒ…çš„ç›®çš„æ˜¯æœ¬ä¸»æœºï¼Œé‚£ä¹ˆå°†è¯¥åŒ…é€ç»™ä¸Šå±‚å¤„ç†ï¼›å¦åˆ™éœ€è¦è¿›è¡Œè½¬å‘ï¼Œå°†æ¥æ”¶åŒ…äº¤åˆ°è½¬å‘å—ï¼ˆForwarding Blockï¼‰å¤„ç†ã€‚è½¬å‘å—åŒæ—¶ä¹Ÿæ¥æ”¶æœ¬ä¸»æœºä¸Šå±‚ï¼ˆTCPã€UDP ç­‰ï¼‰äº§ç”Ÿçš„åŒ…ã€‚è½¬å‘å—é€šè¿‡æŸ¥çœ‹è·¯ç”±è¡¨ï¼Œå†³å®šæ‰€å¤„ç†åŒ…çš„ä¸‹ä¸€è·³ã€‚ç„¶åï¼Œå¯¹åŒ…è¿›è¡Œæ’åˆ—ä»¥ä¾¿å°†å®ƒä»¬ä¼ é€åˆ°è¾“å‡ºæ¥å£ï¼ˆOutput Interfaceï¼‰ã€‚
* ä¸€èˆ¬æˆ‘ä»¬åªèƒ½é™åˆ¶ç½‘å¡å‘é€çš„æ•°æ®åŒ…ï¼Œä¸èƒ½é™åˆ¶ç½‘å¡æ¥æ”¶çš„æ•°æ®åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å˜å‘é€æ¬¡åºæ¥æ§åˆ¶ä¼ è¾“é€Ÿç‡ã€‚ï¼ˆæ§åˆ¶ç½‘å¡å…¥å£æµé‡ï¼Œéœ€è¦æŠŠæ•°æ®åŒ…é‡å®šå‘åˆ°è™šæ‹Ÿè®¾å¤‡ ifbï¼Œ åœ¨ ifb çš„è¾“å‡ºæ–¹å‘å¯ä»¥é…ç½®ï¼Œåé¢ä¼šè¯¦ç»†è¯´è¿™ä¸ªï¼‰
* Linux æµé‡æ§åˆ¶ä¸»è¦æ˜¯åœ¨è¾“å‡ºæ¥å£æ’åˆ—æ—¶è¿›è¡Œå¤„ç†å’Œå®ç°çš„ã€‚

## TC åŸºç¡€

### ç»“æ„

éƒ½æ˜¯ä»¥ä¸€ä¸ªæ ¹ qdisc å¼€å§‹çš„ï¼Œè‹¥æ ¹ qdisc æ˜¯ä¸åˆ†ç±»çš„é˜Ÿåˆ—è§„å®šï¼Œé‚£å®ƒå°±æ²¡æœ‰å­ç±»ï¼Œå› æ­¤ä¸å¯èƒ½åŒ…å«å…¶ä»–çš„å­å¯¹è±¡ï¼Œä¹Ÿä¸ä¼šæœ‰è¿‡æ»¤å™¨ä¸ä¹‹å…³è”ï¼Œå‘é€æ•°æ®æ—¶ï¼Œæ•°æ®åŒ…è¿›å…¥è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢æ’é˜Ÿï¼Œç„¶åæ ¹æ®è¯¥é˜Ÿåˆ—è§„å®šçš„å¤„ç†æ–¹å¼å°†æ•°æ®åŒ…å‘é€å‡ºå»ã€‚

åˆ†ç±»çš„ qdisc å†…éƒ¨åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç±»ï¼Œè€Œæ¯ä¸ªç±»å¯ä»¥åŒ…å«ä¸€ä¸ªé˜Ÿåˆ—è§„å®šæˆ–è€…åŒ…å«è‹¥å¹²ä¸ªå­ç±»ï¼Œè¿™äº›å­ç±»å‹å¯ä»¥åŒ…å«åˆ†ç±»æˆ–è€…ä¸åˆ†ç±»çš„é˜Ÿåˆ—è§„å®šï¼Œå¦‚æ­¤é€’å½’ï¼Œå½¢æˆäº†ä¸€ä¸ªæ ‘ã€‚

å¥æŸ„å·ï¼šqdisc å’Œç±»éƒ½ä½¿ç”¨ä¸€ä¸ªå¥æŸ„è¿›è¡Œæ ‡è¯†ï¼Œä¸”åœ¨ä¸€æ£µæ ‘ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œæ¯ä¸ªå¥æŸ„ç”±ä¸»å·ç å’Œæ¬¡å·ç ç»„æˆ qdisc çš„æ¬¡å·ç å¿…é¡»ä¸º 0ï¼ˆ0 é€šå¸¸å¯ä»¥çœç•¥ä¸å†™ï¼‰

æ ¹ qdisc çš„å¥æŸ„ä¸º 1ï¼šï¼Œä¹Ÿå°±æ˜¯ 1ï¼š0ã€‚ç±»çš„å¥æŸ„çš„ä¸»å·ç ä¸å®ƒçš„çˆ¶è¾ˆç›¸åŒï¼ˆçˆ¶ç±»æˆ–è€…çˆ¶ qdiscï¼‰ï¼Œå¦‚ç±» 1ï¼š1 çš„ä¸»å·ç ä¸åŒ…å«ä»–çš„é˜Ÿåˆ—è§„å®š 1ï¼šçš„ä¸»å·ç ç›¸åŒï¼Œ1ï¼š10 å’Œ 1ï¼š11 ä¸ä»–ä»¬çš„çˆ¶ç±» 1ï¼š1 çš„ä¸»å·ç ç›¸åŒï¼Œä¹Ÿä¸º 1ã€‚

æ–°å»ºä¸€ä¸ªç±»æ—¶ï¼Œé»˜è®¤å¸¦æœ‰ä¸€ä¸ª pfifo_fast ç±»å‹çš„ä¸åˆ†ç±»é˜Ÿåˆ—è§„å®šï¼Œå½“æ·»åŠ ä¸€ä¸ªå­ç±»æ—¶ï¼Œè¿™ä¸ªç±»å‹çš„ qdisc å°±ä¼šè¢«åˆ é™¤ï¼Œæ‰€ä»¥ï¼Œéå¶å­ç±»æ˜¯æ²¡æœ‰é˜Ÿåˆ—è§„å®šçš„ï¼Œæ•°æ®åŒ…æœ€ååªèƒ½åˆ°å¶å­ç±»çš„é˜Ÿåˆ—è§„å®šé‡Œé¢æ’é˜Ÿã€‚

è‹¥ä¸€ä¸ªç±»æœ‰å­ç±»ï¼Œé‚£ä¹ˆå…è®¸è¿™äº›å­ç±»ç«äº‰çˆ¶ç±»çš„å¸¦å®½ï¼Œä½†æ˜¯ï¼Œä»¥é˜Ÿåˆ—è§„å®šä¸ºçˆ¶è¾ˆçš„ç±»ä¹‹é—´æ˜¯ä¸å…è®¸ç›¸äº’ç«äº‰å¸¦å®½çš„ã€‚

### åŸºæœ¬å‘½ä»¤

* add å‘½ä»¤ï¼šåœ¨ä¸€ä¸ªèŠ‚ç‚¹é‡ŒåŠ å…¥ä¸€ä¸ª qdiscï¼Œç±»æˆ–è€…è¿‡æ»¤å™¨ã€‚æ·»åŠ æ—¶ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ªç¥–å…ˆä½œä¸ºå‚æ•°ï¼Œä¼ é€’å‚æ•°æ—¶æ—¢å¯ä»¥ä½¿ç”¨ ID ä¹Ÿå¯ä»¥ç›´æ¥ä¼ é€’è®¾å¤‡çš„æ ¹ï¼Œè‹¥å»ºä¸€ä¸ª qdisc æˆ–è€… filterï¼Œå¯ä»¥ä½¿ç”¨å¥æŸ„æ¥å‘½åï¼Œè‹¥å»ºä¸€ä¸ªç±»ï¼Œä½¿ç”¨ç±»è¯†åˆ«ç¬¦æ¥å‘½åã€‚
* delï¼šåˆ é™¤ç”±æŸä¸ªå¥æŸ„æŒ‡å®šçš„ qdiscï¼Œæ ¹ qdisc ä¹Ÿå¯ä»¥è¢«åˆ é™¤ï¼Œè¢«åˆ é™¤çš„ qdisc ä¸Šçš„æ‰€æœ‰å­ç±»ä»¥åŠé™„å±äºå„ä¸ªç±»çš„è¿‡æ»¤å™¨éƒ½ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚
* changeï¼šä»¥æ›¿ä»£æ–¹å¼ä¿®æ”¹æŸäº›é¡¹ç›®ï¼Œå¥æŸ„å’Œç¥–å…ˆä¸èƒ½ä¿®æ”¹ï¼Œchange å’Œ add è¯­æ³•ç›¸åŒã€‚
* replaceï¼šå¯¹ä¸€ä¸ªç°æœ‰èŠ‚ç‚¹è¿›è¡Œè¿‘äºåŸå­æ“ä½œçš„åˆ é™¤ / æ·»åŠ ï¼Œå¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿™ä¸ªå‘½ä»¤å°±ä¼šå»ºç«‹èŠ‚ç‚¹ã€‚
* linkï¼šåªé€‚ç”¨äº qdiscï¼Œæ›¿ä»£ä¸€ä¸ªç°æœ‰çš„èŠ‚ç‚¹

## æ§åˆ¶å‡ºå£æµé‡ (egress)

é»˜è®¤ TC çš„ qdisc æ§åˆ¶å°±æ˜¯å‡ºå£æµé‡ï¼Œè¦ä½¿ç”¨ TC æ§åˆ¶å…¥å£ï¼Œéœ€è¦æŠŠæµé‡é‡å®šå‘åˆ° ifb ç½‘å¡ï¼Œå…¶å®å°±æ˜¯åŠ äº†ä¸€å±‚ï¼ŒåŸç†ä¸Šè¿˜æ˜¯æ§åˆ¶å‡ºå£ğŸ˜‚ ã€‚

### å…ˆè¯´ classless é˜Ÿåˆ—

ä¸ºä½•è¦å…ˆè¯´ classless é˜Ÿåˆ—ï¼Œæ¯•ç«Ÿè¿™ä¸ªç®€å•å˜›ï¼Œè¦å¿«é€Ÿä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå°±æ˜¯é¦–é€‰äº†ã€‚åŸºäº classless é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæ•…éšœæ¨¡æ‹Ÿï¼Œä¹Ÿå¯ä»¥ç”¨æ¥é™åˆ¶å¸¦å®½ã€‚

TC ä½¿ç”¨ linux network [netem](https://wiki.linuxfoundation.org/networking/netem) æ¨¡å—è¿›è¡Œç½‘ç»œæ•…éšœæ¨¡æ‹Ÿ

#### æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ

* æ·»åŠ ä¸€ä¸ªå›ºå®šå»¶è¿Ÿåˆ°æœ¬åœ°ç½‘å¡ eth0

```
// delay: 100ms
tc qdisc add dev eth0 root netem delay 100ms
```

* ç»™å»¶è¿ŸåŠ ä¸Šä¸Šä¸‹ 10ms çš„æ³¢åŠ¨

```
tc qdisc change dev eth0 root netem delay 100ms 10ms
```

* åŠ ä¸€ä¸ª 25% çš„ç›¸å…³æ¦‚ç‡

> ç›¸å…³æ€§ï¼Œæ˜¯è¿™å½“å‰çš„å»¶è¿Ÿä¼šå’Œä¸Šä¸€æ¬¡æ•°æ®åŒ…çš„å»¶è¿Ÿæœ‰å…³ï¼ŒçŸ­æ—¶é—´é‡Œç›¸é‚»æŠ¥æ–‡çš„å»¶è¿Ÿåº”è¯¥æ˜¯è¿‘ä¼¼çš„è€Œä¸æ˜¯å®Œå…¨éšæœºçš„ã€‚è¿™ä¸ªå€¼æ˜¯ä¸ªç™¾åˆ†æ¯”ï¼Œå¦‚æœä¸º 100%ï¼Œå°±é€€åŒ–åˆ°å›ºå®šå»¶è¿Ÿçš„æƒ…å†µï¼›å¦‚æœæ˜¯ 0% åˆ™é€€åŒ–åˆ°éšæœºå»¶è¿Ÿçš„æƒ…å†µï¼Œ
> Pn = 25% Pn-1 + 75% Random


```
tc qdisc change dev eth0 root netem delay 100ms 10ms 25%
```

* è®©æ³¢åŠ¨å˜æˆæ­£æ€åˆ†å¸ƒçš„

```
tc qdisc change dev eth0 root netem delay 100ms 20ms distribution normal
```

#### æ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…

* è®¾ç½®ä¸¢åŒ…ç‡ä¸º 1%

```
tc qdisc change dev eth0 root netem loss 0.1%
```

* æ·»åŠ ä¸€ä¸ªç›¸å…³æ€§å‚æ•°

> è¿™ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰ä¸¢åŒ…çš„æ¦‚ç‡ä¸ä¸Šä¸€æ¡æ•°æ®åŒ…ä¸¢åŒ…æ¦‚ç‡æœ‰ 25% çš„ç›¸å…³æ€§
> Pn = 25% Pn-1 + 75% Random

```
tc qdisc change dev eth0 root netem loss 0.1% 25%
```

#### æ¨¡æ‹Ÿæ•°æ®åŒ…é‡å¤

* 1% çš„æ•°æ®åŒ…é‡å¤

```
tc qdisc change dev eth0 root netem duplicate 1%
```

#### æ¨¡æ‹ŸåŒ…æŸå

* 2% çš„åŒ…æŸå

```
tc qdisc add dev eth0 root netem corrupt 2%
```

#### æ¨¡æ‹ŸåŒ…ä¹±åº

ç½‘ç»œä¼ è¾“å¹¶ä¸èƒ½ä¿è¯é¡ºåºï¼Œä¼ è¾“å±‚ TCP ä¼šå¯¹æŠ¥æ–‡è¿›è¡Œé‡ç»„ä¿è¯é¡ºåºï¼Œæ‰€ä»¥æŠ¥æ–‡ä¹±åºå¯¹åº”ç”¨çš„å½±å“æ¯”ä¸Šé¢çš„å‡ ç§é—®é¢˜è¦å°ã€‚

æŠ¥æ–‡ä¹±åºå¯å‰é¢çš„å‚æ•°ä¸å¤ªä¸€æ ·ï¼Œå› ä¸ºä¸Šé¢çš„æŠ¥æ–‡é—®é¢˜éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œé’ˆå¯¹å•ä¸ªæŠ¥æ–‡åšæ“ä½œå°±è¡Œï¼Œè€Œä¹±åºåˆ™ç‰µæ¶‰åˆ°å¤šä¸ªæŠ¥æ–‡çš„é‡ç»„ã€‚æ¨¡æ‹ŸæŠ¥ä¹±åºä¸€å®šä¼šç”¨åˆ°å»¶è¿Ÿï¼ˆå› ä¸ºæ¨¡æ‹Ÿä¹±åºçš„æœ¬è´¨å°±æ˜¯æŠŠä¸€äº›åŒ…å»¶è¿Ÿå‘é€ï¼‰ï¼Œnetem æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšã€‚

1. ç¬¬ä¸€ç§æ˜¯å›ºå®šçš„æ¯éš”ä¸€å®šæ•°é‡çš„æŠ¥æ–‡å°±ä¹±åºä¸€æ¬¡ï¼š

* æ¯ 5th (10th, 15th...) çš„åŒ…å»¶è¿Ÿ 10ms

```
tc qdisc change dev eth0 root netem gap 5 delay 10ms
```

2. ç¬¬äºŒç§æ–¹æ³•ä½¿ç”¨æ¦‚ç‡æ¥é€‰æ‹©ä¹±åºï¼Œç›¸å¯¹æ¥è¯´æ›´åå‘å®é™…æƒ…å†µä¸€äº›

* 25 % çš„ç«‹åˆ»å‘é€ï¼ˆ50% çš„ç›¸å…³æ€§ï¼‰ï¼Œå…¶ä½™çš„å»¶è¿Ÿ 10ms

```
tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%
```

3. åªä½¿ç”¨ delay ä¹Ÿå¯èƒ½é€ æˆæ•°æ®åŒ…çš„ä¹±åº

```
 tc qdisc change dev eth0 root netem delay 100ms 75ms
```
> æ¯”å¦‚ first one random 100ms, second random 25msï¼Œè¿™æ ·å°±æ˜¯ä¼šé€ æˆç¬¬ä¸€ä¸ªåŒ…å…ˆäºç¬¬äºŒä¸ªåŒ…å‘é€

#### é™åˆ¶å‡ºå£å¸¦å®½

ä»¥ tbf (Token Bucket Filter) ä¸ºä¾‹ï¼Œ

å‚æ•°è¯´æ˜ï¼š

```
tc qdisc add tbf limit BYTES burst BYTES rate KBPS [mtu BYTES] [peakrate KBPS] [latency TIME] [overhead BYTES] [linklayer TYPE]

rate æ˜¯ç¬¬ä¸€ä¸ªä»¤ç‰Œæ¡¶çš„å¡«å……é€Ÿç‡
peakrate æ˜¯ç¬¬äºŒä¸ªä»¤ç‰Œæ¡¶çš„å¡«å……é€Ÿç‡
peakrate>rate
burst æ˜¯ç¬¬ä¸€ä¸ªä»¤ç‰Œæ¡¶çš„å¤§å°
mtu æ˜¯ç¬¬äºŒä¸ªä»¤ç‰Œæ¡¶çš„å¤§å°
burst>mtu (æ­¤å¤„æ˜¯ä¸ªå‘ï¼Œä¸€å®šè¦ä¿è¯ burst > mtu, è¦ä¸ç„¶ä¸€ä¸ªåŒ…ä¹Ÿå‘ä¸å‡ºäº†)
è‹¥ä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œä¸å¤Ÿï¼Œæ•°æ®åŒ…å°±éœ€è¦ç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ç”± latency å‚æ•°æ§åˆ¶ï¼Œå¦‚æœç­‰å¾…æ—¶é—´è¶…è¿‡ latencyï¼Œé‚£ä¹ˆè¿™ä¸ªåŒ…å°±ä¼šè¢«ä¸¢å¼ƒ
limit å‚æ•°æ˜¯è®¾ç½®æœ€å¤šå…è®¸å¤šå°‘æ•°æ®å¯ä»¥åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…
latency=max((limit-burst)/rate,(limit-mtu)/peakrate);
burst åº”è¯¥å¤§äº mtu å’Œ rate
overhead è¡¨ç¤º ADSL ç½‘ç»œå¯¹æ•°æ®åŒ…çš„å°è£…å¼€é”€
linklayer æŒ‡å®šäº†é“¾è·¯çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯ä»¥å¤ªç½‘æˆ–è€… ATM æˆ– ADSL
ATM å’Œ ADSL æŠ¥å¤´å¼€é”€å‡ä¸º 5 ä¸ªå­—èŠ‚ã€‚
```

* exampleï¼š

é™åˆ¶ 100mbit

```
tc qdisc add dev ens33 root tbf rate 100mbit latency 50ms burst 1600
```

é™åˆ¶å»¶è¿Ÿ 100ms, æµé‡ 100mbit

```
tc qdisc add dev eth0 root handle 1:0 netem delay 100ms
tc qdisc add dev eth0 parent 1:1 handle 10: tbf rate 256kbit buffer 1600 limit 3000
```

### classful é˜Ÿåˆ—

è¿™ä¸ªå°±å¤æ‚ä¸€äº›ï¼ŒåŒæ ·ä¹Ÿç‰¹åˆ«çµæ´»ï¼Œå¯ä»¥é™åˆ¶ç‰¹å®šçš„ ip æˆ–è€…æœåŠ¡ç±»å‹ä»¥åŠç«¯å£

ä»¥ä½¿ç”¨ htb ä¸ºä¾‹

```
// ç»™ root æ·»åŠ  htb é˜Ÿåˆ— id: 1:0
tc qdi sc add dev eth0 root handle 1: htb default 20
// ç»™ htb é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ª classï¼Œ clas id: 1:1
tc class add dev eth0 parent 1:0 classid 1:1 htb rate 100mbit burst 10k
// ç»™è¿™ä¸ª class 1:1 åŠ ä¸Šä¸€ä¸ª filter, æ­¤ filter åªæ˜¯å¯¹ ip åšäº†è¿‡æ»¤
tc filter add dev eth0 parent 1: protocol ip prio 16 u32  match ip dst 0.0.0.0/0 flowid 1:1
```

## æ§åˆ¶å…¥å£æµé‡

ä½¿ç”¨ TC è¿›è¡Œå…¥å£é™æµï¼Œéœ€è¦æŠŠæµé‡é‡å®šå‘åˆ° ifb è™šæ‹Ÿç½‘å¡ï¼Œç„¶ååœ¨æ§åˆ¶ ifb çš„è¾“å‡ºæµé‡

åŸç†å›¾ï¼š

![](http://7xnp02.com1.z0.glb.clouddn.com/1354528849_1019.png)

```
// å¼€å¯ ifb è™šæ‹Ÿç½‘å¡
modprobe ifb numifbs=1
ip link set dev $IFB up

// å°† eth0 æµé‡é‡å®šå‘åˆ° ifb0
tc qdisc add dev eth0 handle ffff: ingress
tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0

// ç„¶åå°±æ˜¯é™åˆ¶ ifb0 çš„è¾“å‡ºå°±å¯ä»¥äº†
......
```

## åœ¨è¯´å‡ å¥

TC è¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰å»ç ”ç©¶åˆ°ï¼Œç›®å‰è¿™äº›åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ç›®å‰çš„éœ€æ±‚ï¼Œæœ€åè¿˜æƒ³åæ§½ä¸€å¥ï¼Œå½“ TC å‘½ä»¤å‡ºé”™çš„æ—¶å€™ï¼ŒTC çš„æŠ¥é”™ä¿¡æ¯å¤ªå°‘äº†ï¼Œè°ƒè¯•èµ·æ¥å¤ªå‘...

> [wondershaper](https://github.com/magnific0/wondershaper) è¿™ä¸ªè„šæœ¬ç”¨èµ·æ¥è¿˜æ˜¯å¾ˆæ–¹ä¾¿

## å‚è€ƒ

1. [Traffic Control HOWTO](http://www.tldp.org/HOWTO/html_single/Traffic-Control-HOWTO/)
2. [netem](https://wiki.linuxfoundation.org/networking/netem)
3. [Linux æµé‡æ§åˆ¶å·¥å…· TC](http://www.ituring.com.cn/article/274015)
4. [æµé‡æ§åˆ¶å·¥å…· TC è¯¦ç»†è¯´æ˜](http://www.ituring.com.cn/article/274014)
5. [Linux ä¸‹ TC ä»¥åŠ netem é˜Ÿåˆ—çš„ä½¿ç”¨](http://blog.51cto.com/professor/1570778)
6. [è¾“å…¥æ–¹å‘çš„æµé‡æ§åˆ¶](https://blog.csdn.net/zhangskd/article/details/8240290)
7. [wondershaper](https://github.com/magnific0/wondershaper)
